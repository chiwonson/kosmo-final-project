<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- 카카오 Maps API Script -->
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=2719e001cd811b9e735d7b0555310d3b&libraries=services"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <title>선택된 메뉴</title>
  <style>
      /* 기본 body 스타일 설정 */
      body {
          font-family: Arial, sans-serif;
          display: flex;
          flex-direction: column;
          align-items: center;
          height: 100vh;
          margin: 0;
          padding-top: 20px; /* 상단 여백을 20px로 설정 */
          background-color: #ffffff;
          color: #000000;
      }
      /* 컨테이너 스타일 설정 */
      .container {
          height: 100%; /* 컨테이너의 높이를 100%로 설정 */
          padding: 0;
          display: flex;
          flex-direction: column;
          justify-content: center;
      }
      /* 행 스타일 설정 */
      .row {
          height: 100%; /* 행의 높이를 100%로 설정 */
          width: 100%; /* 행의 너비를 100%로 설정 */
          margin: 0;
      }
      /* 각 열 스타일 설정 */
      .col-md-4 {
          display: flex;
          flex-direction: column;
          justify-content: space-between; /* 콘텐츠를 위아래로 배치 */
          padding: 0;
      }
      .col-md-4.left-column {
          width: 20%; /* 첫 번째 열의 너비를 20%로 설정 */
      }
      .col-md-4.middle-column {
          width: 60%; /* 두 번째 열의 너비를 60%로 설정 */
          height: 100%;
      }
      .col-md-4.right-column {
          width: 20%; /* 세 번째 열의 너비를 20%로 설정 */
      }
      /* 메뉴 컨테이너 스타일 설정 */
      .menu-container {
          text-align: center;
          padding: 20px;
          border: 1px solid #ffffff;
          border-radius: 10px;
          background-color: #f9f9f9;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          margin: 10px;
      }
      .menu-title {
          font-size: 24px;
          margin-bottom: 20px;
          color: #000000;
      }
      .menu-item {
          font-size: 20px;
          color: #000000;
      }
      .menu-button {
          padding: 10px 20px;
          font-size: 16px;
          color: #ffffff;
          background-color: #000000;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          transition: background-color 0.3s ease;
          margin: 5px;
      }
      .menu-button:hover {
          background-color: #333333;
      }
      #map {
          width: 100%;
          height: calc(100vh - 200px); /* 지도의 높이를 100vh에서 200px 뺀 값으로 설정 */
          margin-top: 20px;
          background-color: #f9f9f9;
          position: relative;
      }
      .map-overlay-button {
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 10;
          background-color: #000000;
          color: #ffffff;
          border: 2px solid #000000; /* 테두리 색상 추가 */
          border-radius: 5px;
          padding: 10px;
          cursor: pointer;
      }
      .map-overlay-button:hover {
        background-color: #333333;
      }

      /* iframe 컨테이너 스타일 설정 */
      .iframe-container {
          position: relative;
          width: 100%;
          height: calc(100vh - 200px); /* iframe 컨테이너의 높이를 100vh에서 200px 뺀 값으로 설정 */
          border: 1px solid #ddd;
          border-radius: 5px;
          background-color: #ffffff;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
          display: none; /* 기본적으로 숨김 */
          overflow: hidden; /* overflow를 hidden으로 설정하여 스크롤 방지 */
          display: flex;
          justify-content: center;
          align-items: center;
      }
      iframe {
          width: 90%; /* iframe의 너비를 90%로 설정 */
          height: 90%; /* iframe의 높이를 90%로 설정 */
          border: none;
          object-fit: contain; /* iframe의 비율을 유지하면서 크기 조절 */
      }
      .col-md-4.hidden {
          display: none; /* 기본적으로 숨김 */
      }
      /* 레스토랑 리스트 스타일 설정 */
      .restaurant-list {
          list-style: none;
          padding: 0;
          max-height: 400px; /* 최대 높이를 설정하여 스크롤 가능하도록 설정 */
          overflow-y: auto; /* 세로 스크롤바 추가 */
      }
      .restaurant-item {
          border-bottom: 1px solid #ddd;
          padding: 10px 0;
          text-align: left;
          color: #000000;
      }
      /* 랭킹 리스트 스타일 설정 */
      .ranking-list {
          padding: 20px;
          background-color: #f9f9f9;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          margin-top: 20px;
      }
      .ranking-item {
          font-size: 18px;
          margin-bottom: 10px;
          color: #000000;
      }
  </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <div class="container text-center">
        <div class="row">
            <!-- 왼쪽 열 -->
            <div class="col-md-4 left-column">
                <div id="menu-container" class="menu-container">
                    <div class="menu-item" id="menu-item">추천 항목이 없습니다.</div>
                    <button class="menu-button" onclick="getAnotherRestaurant()">추천</button><br/>
                    <!-- 카페/빵집 리스트를 추가할 영역 -->
                    <ul id="restaurant-list" class="restaurant-list"></ul>
                    <div class="ranking-list" id="ranking-list">
                        <div class="ranking-item" id="rank-1"></div>
                        <div class="ranking-item" id="rank-2"></div>
                        <div class="ranking-item" id="rank-3"></div>
                    </div>
                </div>
                
            </div>

            <!-- 중간 열 -->
            <div class="col-md-4 middle-column">
                <div id="map" class="map">
                    <button class="map-overlay-button" onclick="locateCurrentPosition()">현재 위치 확인</button>
                </div>
            </div>

            <!-- 오른쪽 열 -->
            <div class="col-md-4 right-column hidden" id="iframe-column">
                <div id="iframe-container" class="iframe-container">
                    <iframe id="iframe" src="" frameborder="0"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let infowindow;
        let currentAddress = '';
        let landAddress = '';
        let markers = [];
        let restaurantLink = ""; // 링크를 빈 문자열로 초기화
        let allPlaces = []; // 모든 장소 정보를 저장하는 배열

        // 초기 지도 설정
        function initMap() {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(37.566826, 126.9786567),
                level: 12
            };

            map = new kakao.maps.Map(mapContainer, mapOption);
            infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });

            // 지도 클릭 이벤트 추가
            kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                const latlng = mouseEvent.latLng;
                findNearbyPlaces(latlng);
            });
        }

        // 현재 위치로 이동하는 함수
        function locateCurrentPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const newCenter = new kakao.maps.LatLng(lat, lon);
                        map.setCenter(newCenter);
                        map.setLevel(5); // 확대 레벨 조정

                        // Reverse Geocoding API 요청
                        const geocoder = new kakao.maps.services.Geocoder();

                        geocoder.coord2Address(lon, lat, (result, status) => {
                            if (status === kakao.maps.services.Status.OK) {
                                // 도로명 주소
                                const roadAddress = result[0].road_address ? result[0].road_address.address_name : '';
                                // 지번 주소
                                landAddress = result[0].address.address_name;

                                currentAddress = roadAddress || landAddress;
                                findNearbyPlaces(newCenter);
                            } else {
                                console.error('주소를 가져오는 데 실패했습니다:', status);
                            }
                        });
                    },
                    function(error) {
                        console.error('Error getting location:', error);
                    }
                );
            } else {
                alert('이 브라우저는 Geolocation을 지원하지 않습니다.');
            }
        }

        // 새로운 음식점 추천하는 함수
        function getAnotherRestaurant() {
            if (allPlaces.length > 0) {
                const randomIndex = Math.floor(Math.random() * allPlaces.length);
                const randomPlace = allPlaces[randomIndex];
                restaurantLink = randomPlace.place_url;

                // iframe에 링크 설정
                const iframe = document.getElementById('iframe');
                iframe.src = restaurantLink;

                // iframe 컬럼 표시
                const iframeColumn = document.getElementById('iframe-column');
                iframeColumn.style.display = 'flex';

                // 음식점 리스트 업데이트
                updateRestaurantList(allPlaces);
            } else {
                alert('위치를 선택해주세요.');
            }
        }

        // 주변 장소를 검색하는 함수
        function findNearbyPlaces(location) {
            const ps = new kakao.maps.services.Places();

            // 기존 마커 제거
            removeMarkers();

            const searchOptions = {
                location: location, // 검색 중심 위치를 클릭된 좌표로 설정
                radius: 1500 // 반경 설정 (단위: 미터)
            };

            allPlaces = []; // 검색된 장소를 저장할 배열 초기화

            // "베이커리", "빵", "제과" 키워드로 검색
            const keywords = ['베이커리', '빵', '제과'];
            let completedRequests = 0;

            keywords.forEach(keyword => {
                ps.keywordSearch(keyword, (data, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        allPlaces = allPlaces.concat(data);
                    } else {
                        console.error(`키워드 "${keyword}" 검색에 실패했습니다. 상태 코드:`, status);
                    }
                    completedRequests++;
                    if (completedRequests === keywords.length) {
                        handleSearchResults(allPlaces);
                    }
                }, searchOptions);
            });
        }

        // 검색 결과를 처리하는 함수
        function handleSearchResults(data) {
            console.log('검색 결과:', data);
            const bounds = new kakao.maps.LatLngBounds();
            // 검색된 장소를 지도에 마커로 표시
            if (data.length > 0) {
                // 순위에 따라 상위 3개의 장소를 선택
                const topPlaces = data.slice(0, 3);

                // iframe에 첫 번째 장소의 링크 설정
                restaurantLink = topPlaces[0].place_url;
                const iframe = document.getElementById('iframe');
                iframe.src = restaurantLink;

                // iframe 컬럼 표시
                const iframeColumn = document.getElementById('iframe-column');
                iframeColumn.style.display = 'flex';

                // 검색된 장소에 대한 마커 표시
                for (let i = 0; i < topPlaces.length; i++) {
                    displayMarker(topPlaces[i]);
                    bounds.extend(new kakao.maps.LatLng(topPlaces[i].y, topPlaces[i].x));
                }
                map.setBounds(bounds);

                // 음식점 리스트 업데이트
                updateRestaurantList(data);
                // 랭킹 리스트 업데이트
                updateRankingList(topPlaces);
            } else {
                alert('장소 검색 결과가 없습니다.');
            }
        }

        // 장소 마커를 표시하는 함수
        function displayMarker(place) {
            const marker = new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(place.y, place.x)
            });

            markers.push(marker);

            // 마커 클릭 시 인포윈도우에 장소 정보 표시
            kakao.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
                infowindow.open(map, marker);
            });
        }

        // 음식점 리스트를 업데이트하는 함수
        function updateRestaurantList(data) {
            const list = document.getElementById('restaurant-list');
            list.innerHTML = ''; // 기존 리스트 초기화

            data.forEach(place => {
                const listItem = document.createElement('li');
                listItem.className = 'restaurant-item';
                listItem.innerHTML = `
                    <strong>${place.place_name}</strong><br>
                    ${place.road_address_name || place.address_name}<br>
                    <a href="${place.place_url}" target="_blank">상세 보기</a>
                `;
                list.appendChild(listItem);
            });
        }

        // 랭킹 리스트를 업데이트하는 함수
        function updateRankingList(topPlaces) {
            const rank1 = document.getElementById('rank-1');
            const rank2 = document.getElementById('rank-2');
            const rank3 = document.getElementById('rank-3');

            rank1.innerHTML = `<strong>1위: ${topPlaces[0].place_name}</strong><br>${topPlaces[0].road_address_name || topPlaces[0].address_name}<br><a href="${topPlaces[0].place_url}" target="_blank">상세 보기</a>`;
            rank2.innerHTML = `<strong>2위: ${topPlaces[1].place_name}</strong><br>${topPlaces[1].road_address_name || topPlaces[1].address_name}<br><a href="${topPlaces[1].place_url}" target="_blank">상세 보기</a>`;
            rank3.innerHTML = `<strong>3위: ${topPlaces[2].place_name}</strong><br>${topPlaces[2].road_address_name || topPlaces[2].address_name}<br><a href="${topPlaces[2].place_url}" target="_blank">상세 보기</a>`;
        }

        // 기존 마커를 제거하는 함수
        function removeMarkers() {
            for (let i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }

        // 초기화 함수 호출
        window.onload = initMap;
    </script>
</body>
</html>
